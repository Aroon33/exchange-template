<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - å•ã„åˆã‚ã›ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- å…±é€š + Admin å°‚ç”¨CSS -->
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    <ul class="nav-list">
      <li class="nav-item">
        <a href="index.html" class="nav-link">
          <span class="nav-icon">ğŸ </span><span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="tickets.html" class="nav-link active">
          <span class="nav-icon">ğŸ’¬</span><span>å•ã„åˆã‚ã›ç®¡ç†</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="users.html" class="nav-link">
          <span class="nav-icon">ğŸ‘¥</span><span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="trades.html" class="nav-link">
          <span class="nav-icon">ğŸ“Š</span><span>å–å¼•çŠ¶æ³</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="kyc.html" class="nav-link">
          <span class="nav-icon">ğŸ“Š</span><span>KYCçŠ¶æ³</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="deposit.html" class="nav-link">
          <span class="nav-icon">â•</span><span>å…¥é‡‘ç”³è«‹</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="withdraw.html" class="nav-link">
          <span class="nav-icon">â–</span><span>å‡ºé‡‘ç”³è«‹</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="group.html" class="nav-link">
          <span class="nav-icon">ğŸ§©</span><span>ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="settings.html" class="nav-link">
          <span class="nav-icon">âš™ï¸</span><span>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</span>
        </a>
      </li>
    </ul>
    <div class="sidebar-footer">
      CryptoX Admin<br />UI Demo &copy; 2025
    </div>
  </aside>

  <!-- Header -->
  <header class="admin-header">
    <div class="admin-header-left">
      <div class="admin-logo-badge">AX</div>
      <div>
        <div class="admin-logo-text">Admin Console</div>
        <div class="admin-logo-sub">å•ã„åˆã‚ã›ç®¡ç†</div>
      </div>
    </div>
    <div class="admin-header-right">
      <span>ç®¡ç†è€…ï¼šadmin@example.com</span>
      <button class="btn btn-outline btn-sm" onclick="location.href='../login.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒ¢ï¼‰</button>
    </div>
  </header>

  <!-- Main -->
  <main class="admin-main">
    <div class="admin-main-inner">
      <div class="page-title">å•ã„åˆã‚ã›ç®¡ç†</div>
      <div class="page-sub">
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å•ã„åˆã‚ã›ã‚’ä¸€è¦§ãƒ»æ¤œç´¢ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã‚„ãƒãƒ£ãƒƒãƒˆè¿”ä¿¡ã‚’è¡Œã†ãƒ‡ãƒ¢ç”»é¢ã§ã™ã€‚
      </div>

      <!-- Filters -->
      <section class="filters-card">
        <div class="filters-row">
          <div>
            <div class="filters-title">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
            <div class="filters-meta">
              ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ»æœŸé–“ã§ãƒã‚±ãƒƒãƒˆã‚’çµã‚Šè¾¼ã¿ã¾ã™ã€‚
            </div>
          </div>
          <div class="status-tabs">
            <button class="status-tab-btn active" data-status="all">ã™ã¹ã¦</button>
            <button class="status-tab-btn" data-status="new">æœªå¯¾å¿œ</button>
            <button class="status-tab-btn" data-status="open">å¯¾å¿œä¸­</button>
            <button class="status-tab-btn" data-status="closed">å¯¾å¿œæ¸ˆ</button>
          </div>
        </div>
        <div class="filters-grid">
          <div class="field">
            <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä»¶åãƒ»æœ¬æ–‡ï¼‰</label>
            <input type="text" id="f-keyword" placeholder="ä¾‹ï¼šå…¥é‡‘ / ã‚¨ãƒ©ãƒ¼ / ã‚·ã‚¹ãƒ†ãƒ å–å¼•" />
          </div>
          <div class="field">
            <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
            <input type="text" id="f-user" placeholder="ä¾‹ï¼šuser-demo-001" />
          </div>
          <div class="field">
            <label>æœŸé–“ï¼ˆFromï¼‰</label>
            <input type="date" id="f-from" />
          </div>
          <div class="field">
            <label>æœŸé–“ï¼ˆToï¼‰</label>
            <input type="date" id="f-to" />
          </div>
        </div>
      </section>

      <!-- Two panes -->
      <section class="pane-grid">
        <!-- Left: list -->
        <div class="card">
          <div class="card-header-row">
            <div>
              <div class="card-title-small">å•ã„åˆã‚ã›ä¸€è¦§</div>
              <div class="card-sub-small" id="list-count">0ä»¶</div>
            </div>
            <button class="btn-xs-outline" id="btn-refresh">å†èª­ã¿è¾¼ã¿</button>
          </div>
          <div class="ticket-list" id="ticket-list">
            <!-- JS -->
          </div>
        </div>

        <!-- Right: detail & chat -->
        <div class="card">
          <div class="detail-header">
            <div>
              <div class="detail-title" id="detail-title">å•ã„åˆã‚ã›ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
              <div class="detail-meta" id="detail-meta">
                å·¦å´ã®ä¸€è¦§ã‹ã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’é¸æŠã™ã‚‹ã¨ã€ã“ã“ã«è©³ç´°ã¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--text-muted); margin-bottom:2px;">
                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
              </div>
              <select class="status-select" id="status-select" disabled>
                <option value="new">æœªå¯¾å¿œ</option>
                <option value="open">å¯¾å¿œä¸­</option>
                <option value="closed">å¯¾å¿œæ¸ˆ</option>
              </select>
            </div>
          </div>

          <div class="chat-window" id="chat-window">
            <div class="chat-empty">ã¾ã ã‚¹ãƒ¬ãƒƒãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
          </div>

          <div class="reply-area" id="reply-area" style="display:none;">
            <div class="toolbar">
              <button class="btn-xs-outline" id="btn-close-ticket">å¯¾å¿œæ¸ˆã¨ã—ã¦ã‚¯ãƒ­ãƒ¼ã‚º</button>
            </div>
            <div class="reply-row">
              <textarea id="reply-text" placeholder="ã‚µãƒãƒ¼ãƒˆã‹ã‚‰ã®è¿”ä¿¡å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"></textarea>
              <button class="btn-xs-primary" id="btn-send-reply">è¿”ä¿¡ã‚’é€ä¿¡</button>
            </div>
            <div class="note">
              ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒã€Œå¯¾å¿œæ¸ˆã€ã«å¤‰æ›´ã•ã‚Œã‚‹ã¨ã€ã“ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¯ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã‹ã‚‰ã¯è¿½è¨˜ã§ããªããªã‚Šã¾ã™ï¼ˆãƒ‡ãƒ¢ï¼‰ã€‚
            </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>
  <script>
  const API_BASE = 'http://localhost:3000'; // å¿…è¦ã«å¿œã˜ã¦å¤‰æ›´

  const listBoxEl   = document.getElementById("tickets-list");
  const detailBoxEl = document.getElementById("ticket-detail");
  const msgListEl   = document.getElementById("messages");
  const replyInput  = document.getElementById("reply-input");
  const replyBtn    = document.getElementById("reply-send");
  const statusSelect= document.getElementById("status-select");
  const statusBtn   = document.getElementById("status-update");
  const toastEl     = document.getElementById("toast");

  let allTickets = [];
  let currentId  = null;

  function showToast(msg) {
    if (!toastEl) return;
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 2200);
  }

  async function apiGet(path) {
    const res = await fetch(API_BASE + path, { credentials: "include" });
    if (!res.ok) throw new Error("GET " + path + " failed");
    return res.json();
  }

  async function apiPost(path, body) {
    const res = await fetch(API_BASE + path, {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: body ? JSON.stringify(body) : "{}",
    });
    const txt = await res.text();
    let json;
    try { json = txt ? JSON.parse(txt) : {}; } catch { json = { raw: txt }; }
    if (!res.ok) throw new Error("POST " + path + " failed");
    return json;
  }

  async function loadTickets() {
    const data = await apiGet("/tickets/admin/all");
    allTickets = Array.isArray(data) ? data : [];
    renderList();
  }

  function renderList() {
    if (!listBoxEl) return;
    listBoxEl.innerHTML = "";

    if (allTickets.length === 0) {
      listBoxEl.innerHTML =
        '<div style="font-size:12px; color:var(--text-muted); text-align:center; padding:20px;">ãƒã‚±ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
      currentId = null;
      renderDetail();
      return;
    }

    allTickets.forEach((t) => {
      const div = document.createElement("div");
      div.className = "item-row" + (t.id === currentId ? " active" : "");
      div.dataset.id = t.id;

      div.innerHTML = `
        <div>
          <div class="item-title">[${t.status}] ${t.title}</div>
          <div class="item-meta">
            User #${t.userId} (${t.email})<br>
            ä½œæˆ: ${new Date(t.createdAt).toLocaleString("ja-JP", { hour12:false })}
          </div>
        </div>
        <div class="item-meta">ID: ${t.id}</div>
      `;

      div.addEventListener("click", () => {
        currentId = t.id;
        renderList();
        renderDetail();
      });

      listBoxEl.appendChild(div);
    });

    if (!currentId && allTickets.length > 0) {
      currentId = allTickets[0].id;
      renderList();
      renderDetail();
    }
  }

  async function renderDetail() {
    if (!detailBoxEl || !msgListEl) return;

    const t = allTickets.find((x) => x.id === currentId);
    if (!t) {
      detailBoxEl.innerHTML =
        '<div style="font-size:13px; color:var(--text-muted); padding:20px;">å·¦ã®ä¸€è¦§ã‹ã‚‰ãƒã‚±ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>';
      msgListEl.innerHTML = "";
      return;
    }

    detailBoxEl.innerHTML = `
      <div class="detail-title">[${t.status}] ${t.title}</div>
      <div class="detail-meta">
        User #${t.userId} (${t.email}) /
        ä½œæˆ: ${new Date(t.createdAt).toLocaleString("ja-JP", { hour12:false })}
      </div>
    `;

    try {
      const messages = await apiGet(`/tickets/${t.id}/messages`);
      msgListEl.innerHTML = "";
      messages.forEach((m) => {
        const li = document.createElement("div");
        li.className = "message-row " + (m.sender === "ADMIN" ? "admin" : "user");
        li.innerHTML =
          `<div class="message-meta">${m.sender} / ${new Date(m.createdAt).toLocaleString("ja-JP",{hour12:false})}</div>` +
          `<div class="message-body">${m.message}</div>`;
        msgListEl.appendChild(li);
      });
    } catch (e) {
      console.error(e);
      msgListEl.innerHTML =
        '<div style="font-size:12px; color:var(--text-muted); padding:10px;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</div>';
    }

    if (statusSelect) statusSelect.value = t.status;
  }

  async function sendReply() {
    if (!currentId) {
      showToast("ãƒã‚±ãƒƒãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      return;
    }
    const msg = replyInput.value.trim();
    if (!msg) {
      showToast("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    try {
      await apiPost(`/tickets/admin/${currentId}/reply`, { message: msg });
      replyInput.value = "";
      showToast("è¿”ä¿¡ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚");
      await renderDetail();
    } catch (e) {
      console.error(e);
      showToast("è¿”ä¿¡é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  }

  async function updateStatus() {
    if (!currentId) {
      showToast("ãƒã‚±ãƒƒãƒˆãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
      return;
    }
    const status = statusSelect.value;
    try {
      await apiPost(`/tickets/admin/${currentId}/status`, { status });
      showToast("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");
      await loadTickets();
    } catch (e) {
      console.error(e);
      showToast("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    }
  }

  if (replyBtn)  replyBtn.addEventListener("click", sendReply);
  if (statusBtn) statusBtn.addEventListener("click", updateStatus);

  (function init() {
    loadTickets().catch((e) => {
      console.error(e);
      showToast("ãƒã‚±ãƒƒãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    });
  })();
</script>



</body>
</html>

