<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - å…¥é‡‘ç”³è«‹ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- å…±é€š + Admin å°‚ç”¨CSS -->
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    <ul class="nav-list">
      <li class="nav-item"><a href="index.html" class="nav-link"><span class="nav-icon">ğŸ </span><span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span></a></li>
      <li class="nav-item"><a href="tickets.html" class="nav-link"><span class="nav-icon">ğŸ’¬</span><span>å•ã„åˆã‚ã›ç®¡ç†</span></a></li>
      <li class="nav-item"><a href="users.html" class="nav-link"><span class="nav-icon">ğŸ‘¥</span><span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</span></a></li>
      <li class="nav-item"><a href="trades.html" class="nav-link"><span class="nav-icon">ğŸ“Š</span><span>å–å¼•çŠ¶æ³</span></a></li>
      <li class="nav-item"><a href="kyc.html" class="nav-link"><span class="nav-icon">ğŸ“Š</span><span>KYCçŠ¶æ³</span></a></li>
      <li class="nav-item"><a href="deposit.html" class="nav-link active"><span class="nav-icon">â•</span><span>å…¥é‡‘ç”³è«‹</span></a></li>
      <li class="nav-item"><a href="withdraw.html" class="nav-link"><span class="nav-icon">â–</span><span>å‡ºé‡‘ç”³è«‹</span></a></li>
      <li class="nav-item"><a href="group.html" class="nav-link"><span class="nav-icon">ğŸ§©</span><span>ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</span></a></li>
      <li class="nav-item"><a href="settings.html" class="nav-link"><span class="nav-icon">âš™ï¸</span><span>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</span></a></li>
    </ul>
    <div class="sidebar-footer">CryptoX Admin<br>UI Demo &copy; 2025</div>
  </aside>

  <header class="admin-header">
    <div class="admin-header-left">
      <div class="admin-logo-badge">AX</div>
      <div>
        <div class="admin-logo-text">Admin Console</div>
        <div class="admin-logo-sub">å…¥é‡‘ç”³è«‹ç®¡ç†</div>
      </div>
    </div>
    <div class="admin-header-right">
      <span>ç®¡ç†è€…ï¼šadmin@example.com</span>
      <button class="btn btn-outline btn-sm" onclick="location.href='../login.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒ¢ï¼‰</button>
    </div>
  </header>

  <main class="admin-main">
    <div class="admin-main-inner">
      <div class="page-title">å…¥é‡‘ç”³è«‹ç®¡ç†</div>
      <div class="page-sub">
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥é‡‘ç”³è«‹ã‚’ä¸€è¦§ãƒ»æ¤œç´¢ã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã«å¿œã˜ã¦æ®‹é«˜ã‚’æ›´æ–°ã™ã‚‹ãƒ‡ãƒ¢ç”¨ç”»é¢ã§ã™ã€‚<br>
        ç¾çŠ¶ã¯ localStorageï¼ˆ<code>cx_transfers</code>, <code>cx_wallet_store</code>ï¼‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€API ã«ç½®ãæ›ãˆå¯èƒ½ãªæ§‹é€ ã§ã™ã€‚
      </div>

      <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
      <section class="filters-card">
        <div class="filters-row">
          <div>
            <div class="filters-title">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
            <div class="filters-meta">
              ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãƒ»é€šè²¨ãƒ»æœŸé–“ã§å…¥é‡‘ç”³è«‹ã‚’çµã‚Šè¾¼ã¿ã¾ã™ã€‚
            </div>
          </div>
          <div class="status-tabs">
            <button class="status-tab-btn active" data-status="all">ã™ã¹ã¦</button>
            <button class="status-tab-btn" data-status="pending">ç”³è«‹ä¸­</button>
            <button class="status-tab-btn" data-status="completed">å®Œäº†</button>
            <button class="status-tab-btn" data-status="user_cancel">ãƒ¦ãƒ¼ã‚¶ãƒ¼å–æ¶ˆ</button>
            <button class="status-tab-btn" data-status="admin_cancel">ç®¡ç†å–æ¶ˆ</button>
          </div>
        </div>
        <div class="filters-grid">
          <div class="field">
            <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
            <input type="text" id="f-user" placeholder="ä¾‹ï¼šuser-demo-001" />
          </div>
          <div class="field">
            <label>é€šè²¨</label>
            <select id="f-currency">
              <option value="all">ã™ã¹ã¦</option>
              <option value="JPY">JPY</option>
              <option value="BTC">BTC</option>
              <option value="ETH">ETH</option>
              <option value="USDT">USDT</option>
            </select>
          </div>
          <div class="field">
            <label>æœŸé–“ï¼ˆFromï¼‰</label>
            <input type="date" id="f-from" />
          </div>
          <div class="field">
            <label>æœŸé–“ï¼ˆToï¼‰</label>
            <input type="date" id="f-to" />
          </div>
        </div>
      </section>

      <section class="pane-grid">
        <!-- å·¦ï¼šç”³è«‹ä¸€è¦§ -->
        <div class="card">
          <div class="card-header-row">
            <div>
              <div class="card-title-small">å…¥é‡‘ç”³è«‹ä¸€è¦§</div>
              <div class="card-sub-small" id="list-count">0ä»¶</div>
            </div>
            <button class="btn-xs" id="btn-refresh">å†èª­ã¿è¾¼ã¿</button>
          </div>
          <div class="list-box" id="list-box"></div>
        </div>

        <!-- å³ï¼šè©³ç´° -->
        <div class="card">
          <div class="detail-header">
            <div>
              <div class="detail-title" id="detail-title">ç”³è«‹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
              <div class="detail-meta" id="detail-meta">
                å·¦ã®ä¸€è¦§ã‹ã‚‰å‡ºé‡‘ç”³è«‹ã‚’é¸æŠã™ã‚‹ã¨ã€è©³ç´°ã¨ãƒ­ãƒƒã‚¯çŠ¶æ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--text-muted); margin-bottom:2px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
              <select class="status-select" id="status-select" disabled>
                <option value="pending">ç”³è«‹ä¸­</option>
                <option value="completed">å®Œäº†</option>
                <option value="user_cancel">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                <option value="admin_cancel">ç®¡ç†å´ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
              </select>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-block">
              <div class="info-label">ç”³è«‹æƒ…å ±</div>
              <div class="info-value" id="info-user">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: -</div>
              <div class="wallet-row" id="info-amount">é€šè²¨: - / é‡‘é¡: -</div>
              <div class="wallet-row" id="info-ids">ID: - / method: -</div>
            </div>
            <div class="info-block">
              <div class="info-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼æ®‹é«˜ï¼ˆwallet_storeï¼‰</div>
              <div class="wallet-row" id="wallet-total">ç·æ®‹é«˜: -</div>
              <div class="wallet-row" id="wallet-available">åˆ©ç”¨å¯èƒ½æ®‹é«˜: -</div>
            </div>
          </div>

          <div class="toolbar" id="toolbar" style="display:none;">
            <button class="btn-xs btn-xs-primary" id="btn-apply-status">
              ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ï¼ˆæ®‹é«˜åæ˜ ï¼‰
            </button>
          </div>

          <div class="note">
            ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ã¨æ®‹é«˜åæ˜ ï¼ˆãƒ‡ãƒ¢ç”¨ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ï¼š<br>
            ãƒ»<b>pending â†’ completed</b> : ç·æ®‹é«˜ã¨åˆ©ç”¨å¯èƒ½æ®‹é«˜ã«é‡‘é¡ã‚’åŠ ç®—ã€‚<br>
            ãƒ»<b>pending â†’ cancel</b> : æ®‹é«˜ã¸ã®å½±éŸ¿ãªã—ï¼ˆå…¥é‡‘æœªåæ˜ ã®ã¾ã¾ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰ã€‚<br>
            ãƒ»ãã®ä»–ã®é·ç§»ã¯ãƒ‡ãƒ¢ç”¨ã«ç°¡ç•¥åŒ–ã—ã¦ã„ã¾ã™ã€‚
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>
  <script>
    // ==== è¨­å®šï¼ˆå¿…è¦ã«å¿œã˜ã¦å¤‰æ›´ï¼‰====
    // APIã‚µãƒ¼ãƒãƒ¼ã®URL
    const API_BASE = 'http://localhost:3000'; 
    // æœ¬ç•ªãªã‚‰ 'https://api.exchange-template.com' ãªã©ã«å¤‰æ›´

    // ==== DOM å‚ç…§ ====
    const listBoxEl     = document.getElementById("list-box");
    const listCountEl   = document.getElementById("list-count");
    const statusTabs    = document.querySelectorAll(".status-tab-btn");
    const statusSelectEl= document.getElementById("status-select");
    const detailTitleEl = document.getElementById("detail-title");
    const detailMetaEl  = document.getElementById("detail-meta");
    const infoUserEl    = document.getElementById("info-user");
    const infoAmountEl  = document.getElementById("info-amount");
    const infoIdsEl     = document.getElementById("info-ids");
    const walletTotalEl = document.getElementById("wallet-total");
    const walletAvailEl = document.getElementById("wallet-available");
    const btnApplyStatus= document.getElementById("btn-apply-status");
    const btnRefresh    = document.getElementById("btn-refresh");
    const toolbarEl     = document.getElementById("toolbar");
    const toastEl       = document.getElementById("toast");

    const fUser     = document.getElementById("f-user");
    const fCurrency = document.getElementById("f-currency");
    const fFrom     = document.getElementById("f-from");
    const fTo       = document.getElementById("f-to");

    // ==== çŠ¶æ…‹ ====
    let allDeposits = [];
    let filtered    = [];
    let currentId   = null;
    let currentStatusFilter = "all";

    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 2200);
    }

    function formatDate(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      return d.toLocaleString("ja-JP", { hour12: false });
    }

    function formatAmount(amount) {
      if (amount == null) return "-";
      const num = Number(amount);
      if (isNaN(num)) return String(amount);
      return num.toLocaleString("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 8,
      }) + " USDT"; // é€šè²¨æƒ…å ±ã¯APIã«ç„¡ã„ã®ã§ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£
    }

    function statusLabelFor(status) {
      switch (status) {
        case "PENDING":   return "ç”³è«‹ä¸­";
        case "COMPLETED": return "å®Œäº†";
        case "CANCELED":  return "ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
        default:          return status;
      }
    }

    // ==== API ====

    async function apiGet(path) {
      const res = await fetch(API_BASE + path, {
        credentials: "include",
      });
      if (!res.ok) {
        const txt = await res.text();
        console.error("GET " + path + " failed:", txt);
        throw new Error("GET " + path + " failed");
      }
      return res.json();
    }

    async function apiPost(path, body) {
      const res = await fetch(API_BASE + path, {
        method: "POST",
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
        },
        body: body ? JSON.stringify(body) : "{}",
      });
      const txt = await res.text();
      let json;
      try { json = txt ? JSON.parse(txt) : {}; } catch(e) { json = { raw: txt }; }

      if (!res.ok) {
        console.error("POST " + path + " failed:", json);
        throw new Error("POST " + path + " failed");
      }
      return json;
    }

    // PENDINGå…¥é‡‘ä¸€è¦§ã‚’å–å¾—
    async function loadDepositsFromApi() {
      // ç¾çŠ¶ã¯ PENDINGã®ã¿ã€‚å®Œäº†åˆ†ãªã©ã‚‚è¦‹ãŸã„å ´åˆã¯APIæ‹¡å¼µãŒå¿…è¦
      const data = await apiGet("/deposit/pending");
      allDeposits = Array.isArray(data) ? data : [];
      applyFilters();
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ®‹é«˜ï¼ˆç°¡æ˜“ï¼‰ã‚’å–å¾—
    async function loadWalletForUser(userId) {
      // æœ¬æ¥ã¯ /admin/users/:id/wallet ã®ã‚ˆã†ãªAPIãŒç†æƒ³ã ãŒã€
      // ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã—ã¦ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã® /wallet ç›¸å½“ã®æƒ…å ±ã¯è¡¨ç¤ºãªã—ã€ã«ã™ã‚‹ã€‚
      // å¿…è¦ã§ã‚ã‚Œã°ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«åˆ¥é€”APIã‚’ç”¨æ„ã™ã‚‹ã€‚
      return null;
    }

    // ==== ãƒ•ã‚£ãƒ«ã‚¿ & è¡¨ç¤º ====

    function applyFilters() {
      const uid = fUser.value.trim();
      const cur = fCurrency.value;
      const fromV = fFrom.value;
      const toV   = fTo.value;

      filtered = allDeposits.filter((t) => {
        // status filter
        if (currentStatusFilter !== "all") {
          if (currentStatusFilter === "pending" && t.status !== "PENDING") return false;
          if (currentStatusFilter === "completed" && t.status !== "COMPLETED") return false;
          if (currentStatusFilter === "user_cancel" && t.status !== "CANCELED") return false;
          if (currentStatusFilter === "admin_cancel" && t.status !== "CANCELED") return false;
        }

        // user filterï¼ˆæ•°å€¤userIdã‚’ãã®ã¾ã¾æ–‡å­—åˆ—ã¨ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ï¼‰
        if (uid) {
          if (String(t.userId).indexOf(uid) === -1) return false;
        }

        // currency filterï¼ˆAPIã«é€šè²¨æƒ…å ±ãŒç„¡ã„ã®ã§ã€ä»Šã¯ç„¡åŠ¹ or å›ºå®šï¼‰
        if (cur !== "all") {
          // å¿…è¦ã§ã‚ã‚Œã°ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã« currency ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã—ã¦å¯¾å¿œ
          return false;
        }

        // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿
        const createdTs = t.createdAt ? new Date(t.createdAt).getTime() : 0;
        if (fromV) {
          const ts = new Date(fromV + "T00:00:00").getTime();
          if (createdTs < ts) return false;
        }
        if (toV) {
          const ts = new Date(toV + "T23:59:59").getTime();
          if (createdTs > ts) return false;
        }

        return true;
      });

      filtered.sort((a, b) => {
        const ta = a.updatedAt ? new Date(a.updatedAt).getTime() : 0;
        const tb = b.updatedAt ? new Date(b.updatedAt).getTime() : 0;
        return tb - ta;
      });

      renderList();
    }

    function renderList() {
      listBoxEl.innerHTML = "";
      listCountEl.textContent = filtered.length + "ä»¶";

      if (filtered.length === 0) {
        listBoxEl.innerHTML =
          '<div style="font-size:12px; color:var(--text-muted); text-align:center; padding:30px 4px;">è©²å½“ã™ã‚‹å…¥é‡‘ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        currentId = null;
        renderDetail();
        return;
      }

      filtered.forEach((t) => {
        const div = document.createElement("div");
        div.className = "item-row" + (t.id === currentId ? " active" : "");
        div.dataset.id = t.id;

        const created = formatDate(t.createdAt);
        const statusLabel = statusLabelFor(t.status);

        div.innerHTML = `
          <div>
            <div class="item-title">User #${t.userId}</div>
            <div class="item-meta">
              é‡‘é¡: ${formatAmount(t.amount)}<br>
              ä½œæˆ: ${created}
            </div>
          </div>
          <div style="text-align:right;">
            <div class="status-chip">${statusLabel}</div>
            <div class="item-meta">ID: ${t.id}</div>
          </div>
        `;

        div.addEventListener("click", () => {
          currentId = t.id;
          renderList();
          renderDetail();
        });

        listBoxEl.appendChild(div);
      });

      if (!currentId && filtered.length > 0) {
        currentId = filtered[0].id;
        renderList();
        renderDetail();
      }
    }

    async function renderDetail() {
      const t = filtered.find((x) => x.id === currentId);
      if (!t) {
        detailTitleEl.textContent = "ç”³è«‹ã‚’é¸æŠã—ã¦ãã ã•ã„";
        detailMetaEl.textContent =
          "å·¦ã®ä¸€è¦§ã‹ã‚‰å…¥é‡‘ç”³è«‹ã‚’é¸æŠã™ã‚‹ã¨ã€è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚";
        infoUserEl.textContent    = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: -";
        infoAmountEl.textContent  = "é€šè²¨: - / é‡‘é¡: -";
        infoIdsEl.textContent     = "ID: -";
        walletTotalEl.textContent = "ç·æ®‹é«˜: -";
        walletAvailEl.textContent = "åˆ©ç”¨å¯èƒ½æ®‹é«˜: -";
        statusSelectEl.disabled   = true;
        toolbarEl.style.display   = "none";
        return;
      }

      detailTitleEl.textContent = `å…¥é‡‘ç”³è«‹ ID: ${t.id}`;
      detailMetaEl.innerHTML =
        `<span>User ID: ${t.userId}</span>` +
        `<span>Created: ${formatDate(t.createdAt)}</span><br>` +
        `<span>Updated: ${formatDate(t.updatedAt)}</span>`;

      infoUserEl.textContent   = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${t.userId}`;
      infoAmountEl.textContent = `é€šè²¨: USDT / é‡‘é¡: ${formatAmount(t.amount)}`;
      infoIdsEl.textContent    = `ID: ${t.id}`;

      // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæƒ…å ±ï¼ˆä»Šã¯ç°¡ç•¥åŒ–ã—ã¦ "-" è¡¨ç¤ºï¼‰
      walletTotalEl.textContent = "ç·æ®‹é«˜: -";
      walletAvailEl.textContent = "åˆ©ç”¨å¯èƒ½æ®‹é«˜: -";

      statusSelectEl.value = "completed"; // ã€Œæ‰¿èªã€å‰æ
      statusSelectEl.disabled = false;
      toolbarEl.style.display = "block";
    }

    // ==== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆæ‰¿èªï¼‰ ====

    async function applyStatus() {
      const t = filtered.find((x) => x.id === currentId);
      if (!t) {
        showToast("ç”³è«‹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      const newStatusUi = statusSelectEl.value;
      if (newStatusUi !== "completed") {
        showToast("ç¾åœ¨ã¯ã€Œå®Œäº†ï¼ˆæ‰¿èªï¼‰ã€ã®ã¿APIã§åæ˜ ã—ã¾ã™ã€‚");
        return;
      }

      try {
        await apiPost("/deposit/approve", { id: t.id });
        showToast("å…¥é‡‘ç”³è«‹ã‚’æ‰¿èªã—ã¾ã—ãŸã€‚ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã«åæ˜ æ¸ˆã¿ã§ã™ã€‚");
        await loadDepositsFromApi();
      } catch (e) {
        console.error(e);
        showToast("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }

    // ==== ã‚¤ãƒ™ãƒ³ãƒˆ ====

    statusTabs.forEach((btn) => {
      btn.addEventListener("click", () => {
        statusTabs.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        currentStatusFilter = btn.dataset.status || "all";
        applyFilters();
      });
    });

    [fUser, fCurrency, fFrom, fTo].forEach((el) =>
      el.addEventListener("change", applyFilters)
    );

    btnApplyStatus.addEventListener("click", () => {
      applyStatus();
    });
    btnRefresh.addEventListener("click", () => {
      loadDepositsFromApi().catch((e) => {
        console.error(e);
        showToast("å…¥é‡‘ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      });
    });

    // ==== åˆæœŸåŒ– ====

    function initDates() {
      const today = new Date();
      const isoToday = today.toISOString().slice(0, 10);
      const weekAgo  = new Date(today.getTime() - 6*24*60*60*1000);
      fTo.value   = isoToday;
      fFrom.value = weekAgo.toISOString().slice(0, 10);
    }

    (function init() {
      initDates();
      loadDepositsFromApi().catch((e) => {
        console.error(e);
        showToast("å…¥é‡‘ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      });
    })();
  </script>


</body>
</html>

