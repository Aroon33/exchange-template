<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Admin - KYCç¢ºèª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- å…±é€š + Admin å°‚ç”¨CSS -->
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/admin.css">
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-title">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    <ul class="nav-list">
      <li class="nav-item"><a href="index.html" class="nav-link"><span class="nav-icon">ğŸ </span><span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span></a></li>
      <li class="nav-item"><a href="tickets.html" class="nav-link"><span class="nav-icon">ğŸ’¬</span><span>å•ã„åˆã‚ã›ç®¡ç†</span></a></li>
      <li class="nav-item"><a href="users.html" class="nav-link"><span class="nav-icon">ğŸ‘¥</span><span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</span></a></li>
      <li class="nav-item"><a href="kyc.html" class="nav-link active"><span class="nav-icon">ğŸªª</span><span>KYCç¢ºèª</span></a></li>
      <li class="nav-item"><a href="trades.html" class="nav-link"><span class="nav-icon">ğŸ“Š</span><span>å–å¼•çŠ¶æ³</span></a></li>
      <li class="nav-item"><a href="deposit.html" class="nav-link"><span class="nav-icon">â•</span><span>å…¥é‡‘ç”³è«‹</span></a></li>
      <li class="nav-item"><a href="withdraw.html" class="nav-link"><span class="nav-icon">â–</span><span>å‡ºé‡‘ç”³è«‹</span></a></li>
      <li class="nav-item"><a href="group.html" class="nav-link"><span class="nav-icon">ğŸ§©</span><span>ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</span></a></li>
      <li class="nav-item"><a href="settings.html" class="nav-link"><span class="nav-icon">âš™ï¸</span><span>ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</span></a></li>
    </ul>
    <div class="sidebar-footer">
      CryptoX Admin<br>UI Demo &copy; 2025
    </div>
  </aside>

  <!-- Header -->
  <header class="admin-header">
    <div class="admin-header-left">
      <div class="admin-logo-badge">AX</div>
      <div>
        <div class="admin-logo-text">Admin Console</div>
        <div class="admin-logo-sub">KYCç¢ºèª</div>
      </div>
    </div>
    <div class="admin-header-right">
      <span>ç®¡ç†è€…ï¼šadmin@example.com</span>
      <button class="btn btn-outline btn-sm" onclick="location.href='../login.html'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒ¢ï¼‰</button>
    </div>
  </header>

  <!-- Main -->
  <main class="admin-main">
    <div class="admin-main-inner">
      <div class="page-title">KYCç¢ºèª</div>
      <div class="page-sub">
        æå‡ºã•ã‚ŒãŸæœ¬äººç¢ºèªæƒ…å ±ã‚’ç¢ºèªã—ã€6æ®µéšã®åˆ¤å®šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä»˜ä¸ã™ã‚‹ãŸã‚ã®ç®¡ç†ç”»é¢ï¼ˆãƒ‡ãƒ¢ï¼‰ã§ã™ã€‚<br />
        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼šå…¨ã¦NG / ã‚»ãƒ«ãƒ•ã‚£ãƒ¼NG / ä½æ‰€è¨¼æ˜NG / æœ¬äººç¢ºèªæ›¸é¡NG / å…¨ã¦OK / 1ã€œ5 OK
      </div>

      <!-- Filters -->
      <section class="filters-card">
        <div class="filters-row">
          <div>
            <div class="filters-title">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
            <div class="filters-meta">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»KYCãƒ¬ãƒ™ãƒ«ã§çµã‚Šè¾¼ã¿ã¾ã™ã€‚</div>
          </div>
          <div>
            <button class="btn-xs" id="btn-clear">æ¡ä»¶ã‚¯ãƒªã‚¢</button>
            <button class="btn-xs btn-xs-primary" id="btn-search">æ¤œç´¢</button>
          </div>
        </div>
        <div class="filters-grid">
          <div class="field">
            <label>ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆåå‰ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼‰</label>
            <input type="text" id="f-keyword" placeholder="ä¾‹ï¼šTaro / user-demo-001" />
          </div>
          <div class="field">
            <label>KYCãƒ¬ãƒ™ãƒ«</label>
            <select id="f-level">
              <option value="all">ã™ã¹ã¦</option>
              <option value="1">ãƒ¬ãƒ™ãƒ«1</option>
              <option value="2">ãƒ¬ãƒ™ãƒ«2</option>
              <option value="3">ãƒ¬ãƒ™ãƒ«3</option>
            </select>
          </div>
          <div class="field">
            <label>åˆ¤å®šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="f-status">
              <option value="all">ã™ã¹ã¦</option>
              <option value="all_ng">å…¨ã¦NG</option>
              <option value="selfie_ng">ã‚»ãƒ«ãƒ•ã‚£ãƒ¼ãŒNG</option>
              <option value="address_ng">ä½æ‰€è¨¼æ˜ãŒNG</option>
              <option value="id_ng">æœ¬äººç¢ºèªæ›¸é¡ãŒNG</option>
              <option value="all_ok">å…¨ã¦OK</option>
              <option value="steps_ok">1ã€œ5 OK</option>
            </select>
          </div>
        </div>
      </section>

      <!-- List + Detail -->
      <section class="pane-grid">
        <!-- List -->
        <div class="card">
          <div class="card-header-row">
            <div>
              <div class="card-title-small">KYCç”³è«‹ä¸€è¦§</div>
              <div class="card-sub-small" id="list-count">0ä»¶</div>
            </div>
            <button class="btn-xs" id="btn-refresh">å†èª­ã¿è¾¼ã¿</button>
          </div>
          <div class="list-box" id="kyc-list"></div>
        </div>

        <!-- Detail -->
        <div class="card">
          <div class="detail-header">
            <div>
              <div class="detail-title" id="detail-title">ç”³è«‹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
              <div class="detail-meta" id="detail-meta">
                å·¦ã®ä¸€è¦§ã‹ã‚‰ç”³è«‹ã‚’é¸æŠã™ã‚‹ã¨ã€æå‡ºå†…å®¹ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚
              </div>
            </div>
            <div>
              <div style="font-size:11px; color:var(--text-muted); margin-bottom:2px;">åˆ¤å®šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
              <select class="status-select" id="status-select" disabled>
                <option value="all_ng">å…¨ã¦NG</option>
                <option value="selfie_ng">ã‚»ãƒ«ãƒ•ã‚£ãƒ¼ãŒNG</option>
                <option value="address_ng">ä½æ‰€è¨¼æ˜ãŒNG</option>
                <option value="id_ng">æœ¬äººç¢ºèªæ›¸é¡ãŒNG</option>
                <option value="all_ok">å…¨ã¦OK</option>
                <option value="steps_ok">1ã€œ5 OK</option>
              </select>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-block">
              <div class="info-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±</div>
              <div class="info-value" id="info-name">-</div>
              <div class="info-row" id="info-userid">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: -</div>
              <div class="info-row" id="info-email">ãƒ¡ãƒ¼ãƒ«: -</div>
              <div class="info-row" id="info-level">ç”³è«‹ãƒ¬ãƒ™ãƒ«: -</div>
              <div class="info-row" id="info-created">ç”³è«‹æ—¥æ™‚: -</div>
            </div>
            <div class="info-block">
              <div class="info-label">æ›¸é¡ã”ã¨ã®åˆ¤å®š</div>
              <div class="check-list">
                <div class="check-item" id="check-selfie">ã‚»ãƒ«ãƒ•ã‚£ãƒ¼: -</div>
                <div class="check-item" id="check-id">æœ¬äººç¢ºèªæ›¸é¡: -</div>
                <div class="check-item" id="check-address">ä½æ‰€è¨¼æ˜: -</div>
              </div>
              <div class="info-row" id="info-updated">æœ€çµ‚æ›´æ–°: -</div>
            </div>
          </div>

          <div class="toolbar" id="toolbar" style="display:none;">
            <button class="btn-xs btn-xs-primary" id="btn-apply">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°</button>
          </div>
          <div class="note">
            â€» ã“ã®ãƒšãƒ¼ã‚¸ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã¿ã®ãƒ‡ãƒ¢ã§ã™ã€‚<br />
            å®Ÿéš›ã®ç’°å¢ƒã§ã¯ã€APIã‚’é€šã˜ã¦KYCå¯©æŸ»çµæœã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ä¿å­˜ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®KYCãƒ¬ãƒ™ãƒ«ã¨é€£å‹•ã•ã›ã‚‹æƒ³å®šã§ã™ã€‚
          </div>
        </div>
      </section>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    const KYC_KEY = "cx_kyc_requests";

    const statusLabels = {
      all_ng: "å…¨ã¦NG",
      selfie_ng: "ã‚»ãƒ«ãƒ•ã‚£ãƒ¼ãŒNG",
      address_ng: "ä½æ‰€è¨¼æ˜ãŒNG",
      id_ng: "æœ¬äººç¢ºèªæ›¸é¡ãŒNG",
      all_ok: "å…¨ã¦OK",
      steps_ok: "1ã€œ5 OK",
      pending: "æœªãƒ¬ãƒ“ãƒ¥ãƒ¼",
    };

    const levelLabels = {
      1: "ãƒ¬ãƒ™ãƒ«1",
      2: "ãƒ¬ãƒ™ãƒ«2",
      3: "ãƒ¬ãƒ™ãƒ«3",
    };

    const listEl         = document.getElementById("kyc-list");
    const listCountEl    = document.getElementById("list-count");
    const toastEl        = document.getElementById("toast");
    const fKeyword       = document.getElementById("f-keyword");
    const fLevel         = document.getElementById("f-level");
    const fStatus        = document.getElementById("f-status");
    const btnSearch      = document.getElementById("btn-search");
    const btnClear       = document.getElementById("btn-clear");
    const btnRefresh     = document.getElementById("btn-refresh");

    const detailTitleEl  = document.getElementById("detail-title");
    const detailMetaEl   = document.getElementById("detail-meta");
    const statusSelectEl = document.getElementById("status-select");
    const btnApply       = document.getElementById("btn-apply");
    const toolbarEl      = document.getElementById("toolbar");

    const infoNameEl     = document.getElementById("info-name");
    const infoUserIdEl   = document.getElementById("info-userid");
    const infoEmailEl    = document.getElementById("info-email");
    const infoLevelEl    = document.getElementById("info-level");
    const infoCreatedEl  = document.getElementById("info-created");
    const infoUpdatedEl  = document.getElementById("info-updated");

    const checkSelfieEl  = document.getElementById("check-selfie");
    const checkIdEl      = document.getElementById("check-id");
    const checkAddressEl = document.getElementById("check-address");

    let allKyc   = [];
    let filtered = [];
    let currentId = null;

    function showToast(msg) {
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 2200);
    }

    function loadKyc() {
      try {
        const raw = localStorage.getItem(KYC_KEY);
        if (!raw) return seedKyc();
        const data = JSON.parse(raw);
        return Array.isArray(data) ? data : seedKyc();
      } catch (e) {
        console.error(e);
        return seedKyc();
      }
    }

    function seedKyc() {
      const now = Date.now();
      const data = [
        {
          id: "kyc_001",
          userId: "user-demo-001",
          name: "Taro Yamada",
          email: "taro@example.com",
          level: 2,
          status: "selfie_ng",
          selfie: "NG",
          idDoc: "OK",
          address: "OK",
          createdAt: now - 3600 * 1000 * 5,
          updatedAt: now - 3600 * 1000 * 3,
        },
        {
          id: "kyc_002",
          userId: "user-demo-002",
          name: "Hanako Suzuki",
          email: "hanako@example.com",
          level: 1,
          status: "pending",
          selfie: "PENDING",
          idDoc: "PENDING",
          address: "PENDING",
          createdAt: now - 3600 * 1000 * 2,
          updatedAt: now - 3600 * 1000 * 2,
        },
        {
          id: "kyc_003",
          userId: "user-demo-003",
          name: "Crypto Tester",
          email: "tester@example.com",
          level: 3,
          status: "all_ok",
          selfie: "OK",
          idDoc: "OK",
          address: "OK",
          createdAt: now - 3600 * 1000 * 48,
          updatedAt: now - 3600 * 1000 * 24,
        },
      ];
      localStorage.setItem(KYC_KEY, JSON.stringify(data));
      return data;
    }

    function applyFilters() {
      const kw = fKeyword.value.trim().toLowerCase();
      const lv = fLevel.value;
      const st = fStatus.value;

      filtered = allKyc.filter((k) => {
        if (kw) {
          const hay =
            (k.name || "").toLowerCase() +
            " " +
            (k.userId || "").toLowerCase();
          if (!hay.includes(kw)) return false;
        }
        if (lv !== "all" && String(k.level) !== lv) return false;
        if (st !== "all" && k.status !== st) return false;
        return true;
      });

      filtered.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
      renderList();
    }

    function renderList() {
      listEl.innerHTML = "";
      listCountEl.textContent = filtered.length + "ä»¶";

      if (filtered.length === 0) {
        listEl.innerHTML =
          '<div style="font-size:12px; color:var(--text-muted); text-align:center; padding:30px 4px;">è©²å½“ã™ã‚‹KYCç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
        currentId = null;
        renderDetail();
        return;
      }

      filtered.forEach((k) => {
        const row = document.createElement("div");
        row.className = "kyc-row" + (k.id === currentId ? " active" : "");
        row.dataset.id = k.id;

        const stKey = k.status || "pending";
        const badgeClass =
          stKey === "all_ok" || stKey === "steps_ok"
            ? "badge-status-all_ok"
            : stKey === "selfie_ng"
            ? "badge-status-selfie_ng"
            : stKey === "address_ng"
            ? "badge-status-address_ng"
            : stKey === "id_ng"
            ? "badge-status-id_ng"
            : "badge-status-all_ng";

        const label =
          statusLabels[stKey] || (stKey === "pending" ? "æœªãƒ¬ãƒ“ãƒ¥ãƒ¼" : stKey);

        row.innerHTML = `
          <div>
            <div class="user-name">${k.name}</div>
            <div class="user-id">${k.userId}</div>
          </div>
          <div>
            <span class="badge ${badgeClass}">${label}</span>
          </div>
          <div class="user-id">
            ${levelLabels[k.level] || "-"}
          </div>
        `;

        row.addEventListener("click", () => {
          currentId = k.id;
          renderList();
          renderDetail();
        });

        listEl.appendChild(row);
      });

      if (!currentId && filtered.length > 0) {
        currentId = filtered[0].id;
        renderList();
        renderDetail();
      }
    }

    function renderDetail() {
      const k = allKyc.find((x) => x.id === currentId);
      if (!k) {
        detailTitleEl.textContent = "ç”³è«‹ã‚’é¸æŠã—ã¦ãã ã•ã„";
        detailMetaEl.textContent =
          "å·¦ã®ä¸€è¦§ã‹ã‚‰ç”³è«‹ã‚’é¸æŠã™ã‚‹ã¨ã€æå‡ºå†…å®¹ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèªã§ãã¾ã™ã€‚";
        infoNameEl.textContent      = "-";
        infoUserIdEl.textContent    = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: -";
        infoEmailEl.textContent     = "ãƒ¡ãƒ¼ãƒ«: -";
        infoLevelEl.textContent     = "ç”³è«‹ãƒ¬ãƒ™ãƒ«: -";
        infoCreatedEl.textContent   = "ç”³è«‹æ—¥æ™‚: -";
        infoUpdatedEl.textContent   = "æœ€çµ‚æ›´æ–°: -";
        checkSelfieEl.textContent   = "ã‚»ãƒ«ãƒ•ã‚£ãƒ¼: -";
        checkIdEl.textContent       = "æœ¬äººç¢ºèªæ›¸é¡: -";
        checkAddressEl.textContent  = "ä½æ‰€è¨¼æ˜: -";
        statusSelectEl.disabled     = true;
        toolbarEl.style.display     = "none";
        return;
      }

      detailTitleEl.textContent = `${k.name} ã®KYCç”³è«‹`;
      const created = k.createdAt
        ? new Date(k.createdAt).toLocaleString("ja-JP",{hour12:false})
        : "-";
      const updated = k.updatedAt
        ? new Date(k.updatedAt).toLocaleString("ja-JP",{hour12:false})
        : "-";

      detailMetaEl.innerHTML =
        `<span>ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: ${k.userId}</span>` +
        `<span>ãƒ¬ãƒ™ãƒ«: ${levelLabels[k.level] || "-"}</span>`;

      infoNameEl.textContent    = k.name;
      infoUserIdEl.textContent  = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ID: " + k.userId;
      infoEmailEl.textContent   = "ãƒ¡ãƒ¼ãƒ«: " + (k.email || "-");
      infoLevelEl.textContent   = "ç”³è«‹ãƒ¬ãƒ™ãƒ«: " + (levelLabels[k.level] || "-");
      infoCreatedEl.textContent = "ç”³è«‹æ—¥æ™‚: " + created;
      infoUpdatedEl.textContent = "æœ€çµ‚æ›´æ–°: " + updated;

      checkSelfieEl.textContent  = "ã‚»ãƒ«ãƒ•ã‚£ãƒ¼: " + (k.selfie || "-");
      checkIdEl.textContent      = "æœ¬äººç¢ºèªæ›¸é¡: " + (k.idDoc || "-");
      checkAddressEl.textContent = "ä½æ‰€è¨¼æ˜: " + (k.address || "-");

      statusSelectEl.value   = k.status && k.status !== "pending" ? k.status : "all_ng";
      statusSelectEl.disabled = false;
      toolbarEl.style.display = "block";
    }

    function applyStatus() {
      const k = allKyc.find((x) => x.id === currentId);
      if (!k) return;
      const newStatus = statusSelectEl.value;
      const oldStatus = k.status;

      if (oldStatus === newStatus) {
        showToast("ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯å¤‰æ›´ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      k.status    = newStatus;
      k.updatedAt = Date.now();

      localStorage.setItem(KYC_KEY, JSON.stringify(allKyc));
      showToast(`KYCã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã€Œ${statusLabels[newStatus]}ã€ã«æ›´æ–°ã—ã¾ã—ãŸã€‚`);
      applyFilters();
      renderDetail();
    }

    btnSearch.addEventListener("click", applyFilters);
    btnClear.addEventListener("click", () => {
      fKeyword.value = "";
      fLevel.value   = "all";
      fStatus.value  = "all";
      applyFilters();
    });
    btnRefresh.addEventListener("click", () => {
      allKyc = loadKyc();
      applyFilters();
    });
    btnApply.addEventListener("click", applyStatus);

    allKyc = loadKyc();
    applyFilters();
  </script>
</body>
</html>

