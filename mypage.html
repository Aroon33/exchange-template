<!DOCTYPE html>
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Exchange - マイページ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 外部CSS -->
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>

  <header class="site-header">
    <div class="logo">
      <div class="logo-badge">CX</div>
      CryptoX Exchange
    </div>

    <nav class="site-nav">
      <a href="index.html" class="nav-link">TOP</a>
      <a href="exchange.html" class="nav-link">トレード</a>
      <a href="wallet.html" class="nav-link">ウォレット</a>
      <a href="system-trade.html" class="nav-link">システム取引</a>
      <a href="support.html" class="nav-link">サポート</a>
      <a href="mypage.html" class="nav-link active">マイページ</a>
      <a href="kyc.html" class="nav-link">KYC</a>
      <a href="history.html" class="nav-link">取引履歴</a>
    </nav>

    <div class="header-actions">
      <a href="login.html" class="btn btn-outline btn-sm">ログイン</a>
      <a href="signup.html" class="btn btn-primary btn-sm">口座開設</a>
    </div>
  </header>

  <main>
    <section class="card" style="max-width: 720px; margin: 24px auto;">
      <h1 class="card-title">マイページ</h1>
      <p id="mypage-message" class="muted" style="margin-bottom:16px;"></p>

      <h2 class="card-sub">アカウント情報</h2>
      <div class="info-grid">
        <div class="info-row">
          <span class="info-label">メールアドレス</span>
          <span class="info-value" id="my-email">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">名前</span>
          <span class="info-value" id="my-name">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">グループID</span>
          <span class="info-value" id="my-group">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">システムステータス</span>
          <span class="info-value" id="my-system-status">-</span>
        </div>
      </div>

      <h2 class="card-sub">KYC ステータス</h2>
      <div class="info-grid">
        <div class="info-row">
          <span class="info-label">KYCレベル</span>
          <span class="info-value" id="my-kyc-level">-</span>
        </div>
      </div>

      <h2 class="card-sub">残高サマリー</h2>
      <div class="info-grid">
        <div class="info-row">
          <span class="info-label">総残高</span>
          <span class="info-value" id="my-balance-total">0</span>
        </div>
        <div class="info-row">
          <span class="info-label">利用可能残高</span>
          <span class="info-value" id="my-balance-available">0</span>
        </div>
      </div>

      <h2 class="card-sub">入出金履歴</h2>
      <div class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>種別</th>
              <th>金額</th>
              <th>ステータス</th>
              <th>日時</th>
            </tr>
          </thead>
          <tbody id="my-history-body">
            <tr><td colspan="5" style="text-align:center; font-size:12px; color:var(--text-muted);">入出金履歴はありません。</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>


  <!-- API連携スクリプト -->

  <script>
    const API_BASE_URL = "https://api.exchange-template.com";

    const elMsg   = document.getElementById("mypage-message");
    const elEmail = document.getElementById("my-email");
    const elName  = document.getElementById("my-name");
    const elGroup = document.getElementById("my-group");
    const elSys   = document.getElementById("my-system-status");

    const elKycLv = document.getElementById("my-kyc-level");

    const elBalTotal = document.getElementById("my-balance-total");
    const elBalAvail = document.getElementById("my-balance-available");

    const elHistBody = document.getElementById("my-history-body");

    async function apiGet(path) {
      const res = await fetch(API_BASE_URL + path, {
        credentials: "include",
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error("GET " + path + " failed: " + txt);
      }
      return res.json();
    }

    function fmtDate(iso) {
      if (!iso) return "-";
      return new Date(iso).toLocaleString("ja-JP", { hour12: false });
    }

    function fmtAmount(a) {
      if (a == null) return "-";
      const n = Number(a);
      if (isNaN(n)) return String(a);
      return n.toLocaleString("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 8,
      });
    }

    async function loadMe() {
      const data = await apiGet("/auth/me");
      const u = data.user || data;
      if (elEmail) elEmail.textContent = u.email ?? "-";
      if (elName)  elName.textContent  = u.name  ?? "-";
      if (elGroup) elGroup.textContent = (u.groupId != null ? u.groupId : "-");
      if (elSys)   elSys.textContent   = u.systemStatus ?? "-";
    }

    async function loadWalletAndHistory() {
      const data = await apiGet("/wallet");
      const w   = data.wallet || data.balance || {};
      const trs = data.transfers || [];

      const total = w.balanceTotal     ?? w.total     ?? "0";
      const avail = w.balanceAvailable ?? w.available ?? "0";

      if (elBalTotal) elBalTotal.textContent = fmtAmount(total);
      if (elBalAvail) elBalAvail.textContent = fmtAmount(avail);

      if (elHistBody) {
        elHistBody.innerHTML = "";
        if (!trs.length) {
          elHistBody.innerHTML =
            '<tr><td colspan="5" style="text-align:center; font-size:12px; color:var(--text-muted);">入出金履歴はありません。</td></tr>';
        } else {
          trs.forEach((t) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${t.id}</td>
              <td>${t.type}</td>
              <td>${fmtAmount(t.amount)}</td>
              <td>${t.status}</td>
              <td>${fmtDate(t.createdAt)}</td>
            `;
            elHistBody.appendChild(tr);
          });
        }
      }
    }

    async function loadKyc() {
      try {
        const data = await apiGet("/kyc/status");
        if (elKycLv) elKycLv.textContent = data.level ?? "-";
      } catch (e) {
        console.error(e);
        if (elKycLv) elKycLv.textContent = "取得失敗";
      }
    }

    (async function initMypage() {
      try {
        await loadMe();
        await loadWalletAndHistory();
        await loadKyc();
        if (elMsg) {
          elMsg.textContent = "情報を更新しました。";
          elMsg.style.color = "green";
        }
      } catch (e) {
        console.error(e);
        if (elMsg) {
          elMsg.textContent = "情報の取得に失敗しました。ログイン状態を確認してください。";
          elMsg.style.color = "red";
        }
      }
    })();
  </script>
</body>
</html>
