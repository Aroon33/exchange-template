<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Exchange - KYC（本人確認）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .kyc-box {
      margin-top: 20px;
      padding: 16px;
      border: 1px solid var(--border-soft);
      border-radius: 10px;
      background: #fafbfd;
    }
    .kyc-status {
      font-size: 14px;
      margin-bottom: 8px;
    }
    .upload-section {
      margin-top: 12px;
    }
    .upload-section label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .upload-section input {
      padding: 6px;
      width: 100%;
      border: 1px solid var(--border-soft);
      border-radius: 6px;
      background: #fff;
    }
    .btn-submit {
      margin-top: 16px;
      width: 100%;
    }
    .note {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }
  </style>
</head>

<body>

<header class="site-header">
  <div class="logo">
    <div class="logo-badge">CX</div>
    CryptoX Exchange
  </div>
  <nav class="site-nav">
    <a href="index.html" class="nav-link">TOP</a>
    <a href="exchange.html" class="nav-link">トレード</a>
    <a href="wallet.html" class="nav-link">ウォレット</a>
    <a href="system-trade.html" class="nav-link">システム取引</a>
    <a href="support.html" class="nav-link">サポート</a>
    <a href="mypage.html" class="nav-link">マイページ</a>
    <a href="kyc.html" class="nav-link active">KYC</a>
    <a href="history.html" class="nav-link">取引履歴</a>
  </nav>
  <div class="header-actions">
    <a href="login.html" class="btn btn-outline btn-sm">ログイン</a>
    <a href="signup.html" class="btn btn-primary btn-sm">口座開設</a>
  </div>
</header>

<main>
  <section class="card" style="max-width:700px;margin:24px auto;">
    <h1 class="card-title">本人確認（KYC）</h1>
    <p class="muted" id="kyc-msg" style="margin-bottom:16px;"></p>

    <div class="kyc-box">
      <div id="kyc-status" class="kyc-status">ステータス取得中...</div>

      <!-- 画像アップロードフォーム -->
      <div id="kyc-form">
        <div class="upload-section">
          <label>本人確認書類（表面）</label>
          <input type="file" id="front-file" name="files" accept="image/*">
        </div>

        <div class="upload-section">
          <label>本人確認書類（裏面）</label>
          <input type="file" id="back-file" name="files" accept="image/*">
        </div>

        <button class="btn btn-primary btn-submit" id="submit-kyc">
          KYC を提出する
        </button>

        <p class="note">※ JPG/PNGなどの画像ファイルをアップロードしてください。</p>
      </div>
    </div>
  </section>
</main>

<script>
const API_BASE_URL = "https://api.exchange-template.com";

async function apiGet(path) {
  const res = await fetch(API_BASE_URL + path, { credentials: "include" });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

async function apiPostForm(path, formData) {
  const res = await fetch(API_BASE_URL + path, {
    method: "POST",
    credentials: "include",
    body: formData,
  });
  const txt = await res.text();
  if (!res.ok) throw new Error(txt);
  return JSON.parse(txt);
}

// --- KYCステータス表示 ---
async function loadKycStatus() {
  const data = await apiGet("/kyc/status");
  const status = data.status;
  const statusEl = document.getElementById("kyc-status");
  const msgEl = document.getElementById("kyc-msg");

  switch (status) {
    case 0:
      statusEl.textContent = "ステータス：未提出";
      msgEl.textContent = "本人確認書類を提出してください。";
      document.getElementById("kyc-form").style.display = "block";
      break;

    case 1:
      statusEl.textContent = "ステータス：提出済み（一次確認待ち）";
      msgEl.textContent = "審査中です。追加提出が必要な場合はご連絡します。";
      document.getElementById("kyc-form").style.display = "none";
      break;

    case 2:
      statusEl.textContent = "ステータス：審査中";
      msgEl.textContent = "審査中です。結果をお待ちください。";
      document.getElementById("kyc-form").style.display = "none";
      break;

    case 3:
      statusEl.textContent = "ステータス：承認（一次）";
      msgEl.textContent = "審査が進んでいます。最終完了をお待ちください。";
      document.getElementById("kyc-form").style.display = "none";
      break;

    case 4:
      statusEl.textContent = "ステータス：否認";
      msgEl.textContent = "再提出してください。";
      document.getElementById("kyc-form").style.display = "block";
      break;

    case 5:
      statusEl.textContent = "ステータス：KYC完了";
      msgEl.textContent = "本人確認が完了しました。出金が可能です。";
      document.getElementById("kyc-form").style.display = "none";
      break;

    default:
      statusEl.textContent = "ステータス：不明";
      msgEl.textContent = "";
      document.getElementById("kyc-form").style.display = "block";
      break;
  }
}

// --- KYC提出 ---
document.getElementById("submit-kyc").onclick = async () => {
  const front = document.getElementById("front-file").files[0];
  const back = document.getElementById("back-file").files[0];
  const msg = document.getElementById("kyc-msg");

  if (!front || !back) {
    msg.textContent = "両方の画像を選択してください。";
    msg.style.color = "red";
    return;
  }

  const form = new FormData();
form.append("files", front);
form.append("files", back);


  try {
    await apiPostForm("/kyc/submit", form);
    msg.textContent = "KYCを提出しました。審査中です。";
    msg.style.color = "green";

    loadKycStatus();
  } catch (e) {
    msg.textContent = "KYC提出に失敗しました。";
    msg.style.color = "red";
  }
};

// 初期読み込み
loadKycStatus().catch(() => {
  document.getElementById("kyc-msg").textContent = "KYC情報の取得に失敗しました。";
});
</script>

</body>
</html>
