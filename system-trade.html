<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Exchange - システム取引</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 外部CSS -->
  <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

<header class="site-header">
  <div class="logo">
    <div class="logo-badge">CX</div>
    CryptoX Exchange
  </div>

  <nav class="site-nav">
    <a href="index.html" class="nav-link">TOP</a>
    <a href="exchange.html" class="nav-link">トレード</a>
    <a href="wallet.html" class="nav-link">ウォレット</a>
    <a href="system-trade.html" class="nav-link active">システム取引</a>
    <a href="support.html" class="nav-link">サポート</a>
    <a href="mypage.html" class="nav-link">マイページ</a>
    <a href="kyc.html" class="nav-link">KYC</a>
    <a href="history.html" class="nav-link">取引履歴</a>
  </nav>

  <div class="header-actions">
    <a href="login.html" class="btn btn-outline btn-sm">ログイン</a>
    <a href="signup.html" class="btn btn-primary btn-sm">口座開設</a>
  </div>
</header>

<main class="system-page">

  <!-- 左：設定 -->
  <section class="card">
    <div class="card-header">
      <div class="card-title">システム取引設定</div>
      <span class="badge">Demo</span>
    </div>

    <div class="switch-row">
      <span style="font-size:13px;">システム取引（自動売買）</span>
      <div class="switch" id="system-switch">
        <div class="switch-knob"></div>
      </div>
    </div>

    <div class="form-row">
      <label>対象シンボル</label>
      <select id="system-symbol">
        <option value="BTC/USD">BTC / USD</option>
        <option value="ETH/USD">ETH / USD</option>
        <option value="SOL/USD">SOL / USD</option>
        <option value="DOGE/USD">DOGE / USD</option>
      </select>
    </div>

    <div class="form-row">
      <label>戦略テンプレート</label>
      <select id="system-strategy">
        <option value="rsi">RSI 30以下買い / 70以上売り</option>
        <option value="ma">短期MAが長期MAを上抜けで買い</option>
        <option value="grid">グリッドトレード</option>
        <option value="break">ブレイクアウト</option>
      </select>
    </div>

    <div class="form-row">
      <label>最大ポジションサイズ</label>
      <input type="number" id="system-max-position" placeholder="例: 0.5 BTC" />
    </div>

    <div class="form-row">
      <label>損切り (%) ・ 利確 (%)</label>
      <div style="display:flex; gap:8px;">
        <input type="number" id="system-stop" placeholder="-5" />
        <input type="number" id="system-take" placeholder="10" />
      </div>
    </div>

    <div class="form-row">
      <label>注文上限（1日）</label>
      <input type="number" id="system-max-orders" placeholder="例: 50" />
    </div>

    <button id="system-apply" class="btn-primary btn-sm" style="width:100%; margin-top:8px;">
      設定を保存（デモ）
    </button>

    <div class="note" style="margin-top:10px;">
      ※ 本番モードでは、この設定をAPI経由で保存し、
      サーバー側で自動売買ロジックを実行します。
    </div>

    <div class="pill-row" style="margin-top:10px;">
      <span class="pill pill-strong">バックテスト対応</span>
      <span class="pill">複数シンボル同時運用</span>
      <span class="pill">ウォークフォワード</span>
    </div>
  </section>

  <!-- 右：シグナルログ -->
  <section class="card">
    <div class="card-header">
      <div class="card-title">システム取引ログ（シグナル）</div>
    </div>

    <div id="system-log" class="system-log"></div>

    <div class="note">
      デモのためランダムなシグナルを表⽰しています。
      本番では価格データ・戦略ロジックと連動します。
    </div>
  </section>

</main>

<div class="toast" id="toast">
  <span id="toast-text">メッセージ</span>
</div>

<!-- JS（ほぼそのまま残す） -->
<script>
  const API_BASE_URL = "https://api.exchange-template.com";

  const systemSwitch = document.getElementById("system-switch");
  const systemLog = document.getElementById("system-log");
  const systemSymbol = document.getElementById("system-symbol");
  const systemStrategy = document.getElementById("system-strategy");
  const systemMaxPosition = document.getElementById("system-max-position");
  const systemStop = document.getElementById("system-stop");
  const systemTake = document.getElementById("system-take");
  const systemMaxOrders = document.getElementById("system-max-orders");
  const systemApply = document.getElementById("system-apply");
  const toastEl = document.getElementById("toast");
  const toastText = document.getElementById("toast-text");

  let systemOn = false;
  let signalTimer = null;

  /* ---- 将来 API 保存用の土台 ---- */
  async function saveSystemSettings() {
    const payload = {
      symbol: systemSymbol.value,
      strategy: systemStrategy.value,
      maxPosition: systemMaxPosition.value,
      stop: systemStop.value,
      take: systemTake.value,
      maxOrders: systemMaxOrders.value,
    };

    console.log("API送信準備:", payload);

    // 実際は以下に差し替え：
    // await fetch(API_BASE_URL + "/system/settings", {
    //   method: "POST",
    //   credentials: "include",
    //   headers: { "Content-Type": "application/json" },
    //   body: JSON.stringify(payload)
    // });
  }

  function logSystem(msg) {
    const line = document.createElement("div");
    line.className = "system-log-line";
    const time = new Date().toLocaleTimeString("ja-JP", { hour12:false });
    line.textContent = `[${time}] ${msg}`;
    systemLog.prepend(line);
  }

  function showToast(msg) {
    toastText.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 2400);
  }

  systemSwitch.addEventListener("click", () => {
    systemOn = !systemOn;
    systemSwitch.classList.toggle("on", systemOn);

    if (systemOn) {
      startSignals();
      logSystem("システム取引: 有効化");
      showToast("システム取引を有効化（デモ）");
    } else {
      stopSignals();
      logSystem("システム取引: 停止");
      showToast("システム取引を停止（デモ）");
    }
  });

  systemApply.addEventListener("click", async () => {
    logSystem(`設定変更: ${systemSymbol.value}, 戦略=${systemStrategy.value}`);
    showToast("設定を保存（デモ）");
    await saveSystemSettings();
  });

  /* ---- デモ: シグナル生成 ---- */
  function startSignals() {
    stopSignals();
    signalTimer = setInterval(() => {
      if (!systemOn) return;
      generateFakeSignal();
    }, 5000);
  }

  function stopSignals() {
    if (signalTimer) clearInterval(signalTimer);
    signalTimer = null;
  }

  function generateFakeSignal() {
    const side = Math.random() > 0.5 ? "BUY" : "SELL";
    const price = 65000 + (Math.random() - 0.5) * 2000;
    const size = (Math.random() * 0.05 + 0.01).toFixed(4);
    const symbol = systemSymbol.value;

    logSystem(
      `Signal: ${side} ${size} ${symbol.split("/")[0]} @ ${price.toFixed(2)} (${systemStrategy.value})`
    );
  }

  /* INIT */
  logSystem("システム取引画面を開きました（デモ）");

</script>

</body>
</html>

