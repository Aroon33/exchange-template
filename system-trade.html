<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Exchange - システム取引</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 外部CSS -->
  <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

<header class="site-header">
  <div class="logo">
    <div class="logo-badge">CX</div>
    CryptoX Exchange
  </div>

  <nav class="site-nav">
    <a href="index.html" class="nav-link">TOP</a>
    <a href="exchange.html" class="nav-link">トレード</a>
    <a href="wallet.html" class="nav-link">ウォレット</a>
    <a href="system-trade.html" class="nav-link active">システム取引</a>
    <a href="support.html" class="nav-link">サポート</a>
    <a href="mypage.html" class="nav-link">マイページ</a>
    <a href="kyc.html" class="nav-link">KYC</a>
    <a href="history.html" class="nav-link">取引履歴</a>
  </nav>

  <div class="header-actions">
    <a href="login.html" class="btn btn-outline btn-sm">ログイン</a>
    <a href="signup.html" class="btn btn-primary btn-sm">口座開設</a>
  </div>
</header>

  <main>
    <section class="card" style="max-width: 900px; margin: 24px auto;">
      <h1 class="card-title">システム取引</h1>
      <p class="card-sub">
        現在の稼働グループ・システムステータス・口座残高・保有ポジションを表示します。
      </p>
      <p id="sys-message" class="muted" style="margin-bottom: 16px;"></p>

      <div class="info-grid" style="margin-bottom: 16px;">
        <div class="info-row">
          <span class="info-label">グループID</span>
          <span class="info-value" id="sys-group-id">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">システムステータス</span>
          <span class="info-value" id="sys-status">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">合計口座残高</span>
          <span class="info-value" id="sys-balance-total">0</span>
        </div>
      </div>

      <div class="row-inline" style="margin-bottom: 16px; gap: 8px;">
        <button id="sys-stop-btn" class="btn btn-outline">システム停止（ユーザー）</button>
        <button id="sys-start-btn" class="btn btn-primary">システム再開（管理者専用）</button>
      </div>

      <h2 class="card-sub">保有ポジション一覧</h2>
      <div class="table-wrapper">
        <table class="table">
          <thead>
            <tr>
              <th>銘柄</th>
              <th>数量</th>
              <th>建値</th>
              <th>現在値</th>
              <th>評価損益</th>
            </tr>
          </thead>
          <tbody id="sys-positions-body">
            <tr>
              <td colspan="5" style="text-align:center; font-size:12px; color:var(--text-muted);">
                現在保有ポジションはありません。
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

<div class="toast" id="toast">
  <span id="toast-text">メッセージ</span>
</div>

<!-- JS（ほぼそのまま残す） -->
  <script>
    const API_BASE_URL = "https://api.exchange-template.com";

    const elMsg      = document.getElementById("sys-message");
    const elGroupId  = document.getElementById("sys-group-id");
    const elStatus   = document.getElementById("sys-status");
    const elBalTotal = document.getElementById("sys-balance-total");
    const elPosBody  = document.getElementById("sys-positions-body");

    const btnStop  = document.getElementById("sys-stop-btn");
    const btnStart = document.getElementById("sys-start-btn");

    let currentUser = null; // /auth/me の内容を保持（role, id など）

    async function apiGet(path) {
      const res = await fetch(API_BASE_URL + path, {
        credentials: "include",
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error("GET " + path + " failed: " + txt);
      }
      return res.json();
    }

    async function apiPost(path, body) {
      const res = await fetch(API_BASE_URL + path, {
        method: "POST",
        credentials: "include",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body || {}),
      });
      const txt = await res.text();
      let json;
      try { json = txt ? JSON.parse(txt) : {}; } catch { json = { raw: txt }; }
      if (!res.ok) {
        throw new Error("POST " + path + " failed: " + txt);
      }
      return json;
    }

    function showMessage(msg, ok = true) {
      if (!elMsg) return;
      elMsg.textContent = msg;
      elMsg.style.color = ok ? "green" : "red";
    }

    function renderOverview(ov) {
      if (elGroupId)  elGroupId.textContent  = ov.groupId ?? "-";
      if (elStatus)   elStatus.textContent   = ov.systemStatus ?? "-";
      if (elBalTotal) elBalTotal.textContent = String(ov.balanceTotal ?? 0);

      if (elPosBody) {
        elPosBody.innerHTML = "";
        const positions = ov.positions || [];
        if (!positions.length) {
          elPosBody.innerHTML =
            '<tr><td colspan="5" style="text-align:center; font-size:12px; color:var(--text-muted);">現在保有ポジションはありません。</td></tr>';
        } else {
          positions.forEach((p) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${p.symbol}</td>
              <td>${p.size}</td>
              <td>${p.entryPrice}</td>
              <td>${p.currentPrice}</td>
              <td>${p.unrealizedPnl}</td>
            `;
            elPosBody.appendChild(tr);
          });
        }
      }
    }

    async function loadMe() {
      const data = await apiGet("/auth/me");
      currentUser = data.user || data;
      // 管理者以外は「システム再開」ボタンを隠す
      if (currentUser.role !== "ADMIN" && btnStart) {
        btnStart.style.display = "none";
      }
    }

    async function loadOverview() {
      const ov = await apiGet("/system/overview");
      renderOverview(ov);
    }

    async function onStopClick() {
      try {
        await apiPost("/system/stop", {});
        showMessage("システム停止をリクエストしました。", true);
        await loadOverview();
      } catch (e) {
        console.error(e);
        showMessage("システム停止リクエストに失敗しました。", false);
      }
    }

    async function onStartClick() {
      if (!currentUser || currentUser.role !== "ADMIN") {
        showMessage("管理者のみ実行できます。", false);
        return;
      }
      try {
        await apiPost("/system/admin/start", { userId: currentUser.id });
        showMessage("システム再開を実行しました。", true);
        await loadOverview();
      } catch (e) {
        console.error(e);
        showMessage("システム再開に失敗しました。", false);
      }
    }

    if (btnStop)  btnStop.addEventListener("click", (e) => { e.preventDefault(); onStopClick(); });
    if (btnStart) btnStart.addEventListener("click", (e) => { e.preventDefault(); onStartClick(); });

    (async function initSystemTrade() {
      try {
        await loadMe();
        await loadOverview();
        showMessage("システム情報を取得しました。", true);
      } catch (e) {
        console.error(e);
        showMessage("システム情報の取得に失敗しました。ログイン状態を確認してください。", false);
      }
    })();
  </script>
</body>
</html>
