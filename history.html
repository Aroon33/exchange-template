<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CryptoX Exchange - 取引履歴</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- 外部CSS -->
  <link rel="stylesheet" href="assets/css/style.css">
</head>

<body>

<header class="site-header">
  <div class="logo">
    <div class="logo-badge">CX</div>
    CryptoX Exchange
  </div>

  <nav class="site-nav">
    <a href="index.html" class="nav-link">TOP</a>
    <a href="exchange.html" class="nav-link">トレード</a>
    <a href="wallet.html" class="nav-link">ウォレット</a>
    <a href="system-trade.html" class="nav-link">システム取引</a>
    <a href="support.html" class="nav-link">サポート</a>
    <a href="mypage.html" class="nav-link">マイページ</a>
    <a href="kyc.html" class="nav-link">KYC</a>
    <a href="history.html" class="nav-link active">取引履歴</a>
  </nav>

  <div class="header-actions">
    <a href="login.html" class="btn btn-outline btn-sm">ログイン</a>
    <a href="signup.html" class="btn btn-primary btn-sm">口座開設</a>
  </div>
</header>

  <main>
    <section class="card" style="max-width: 980px; margin: 24px auto;">
      <h1 class="card-title">履歴</h1>
      <p class="card-sub">
        入出金履歴と取引履歴を確認できます。
      </p>
      <p id="history-message" class="muted" style="margin-bottom: 16px;"></p>

      <!-- タブ -->
      <div class="row-inline" style="margin-bottom: 16px; gap: 8px;">
        <button id="tab-transfer" class="btn btn-outline btn-sm active">入出金履歴</button>
        <button id="tab-trade" class="btn btn-outline btn-sm">取引履歴</button>
      </div>

      <!-- 入出金履歴テーブル -->
      <section id="section-transfer">
        <h2 class="card-sub">入出金履歴</h2>
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>種別</th>
                <th>金額</th>
                <th>ステータス</th>
                <th>日時</th>
              </tr>
            </thead>
            <tbody id="transfer-history-body">
              <tr>
                <td colspan="5" style="text-align:center; font-size:12px; color:var(--text-muted);">
                  入出金履歴はありません。
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- 取引履歴テーブル -->
      <section id="section-trade" style="display:none;">
        <h2 class="card-sub">取引履歴（確定取引）</h2>
        <div class="table-wrapper">
          <table class="table">
            <thead>
              <tr>
                <th>ID</th>
                <th>銘柄</th>
                <th>売買</th>
                <th>数量</th>
                <th>建値</th>
                <th>決済値</th>
                <th>損益</th>
                <th>決済日時</th>
              </tr>
            </thead>
            <tbody id="trade-history-body">
              <tr>
                <td colspan="8" style="text-align:center; font-size:12px; color:var(--text-muted);">
                  取引履歴はありません。
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <script>
    const API_BASE_URL = "https://api.exchange-template.com";

    const elMsg          = document.getElementById("history-message");
    const elTabTrans     = document.getElementById("tab-transfer");
    const elTabTrade     = document.getElementById("tab-trade");
    const elSecTrans     = document.getElementById("section-transfer");
    const elSecTrade     = document.getElementById("section-trade");
    const elTransBody    = document.getElementById("transfer-history-body");
    const elTradeBody    = document.getElementById("trade-history-body");

    async function apiGet(path) {
      const res = await fetch(API_BASE_URL + path, {
        credentials: "include",
      });
      if (!res.ok) {
        const txt = await res.text();
        throw new Error("GET " + path + " failed: " + txt);
      }
      return res.json();
    }

    function fmtDate(iso) {
      if (!iso) return "-";
      return new Date(iso).toLocaleString("ja-JP", { hour12: false });
    }

    function fmtAmount(a) {
      if (a == null) return "-";
      const n = Number(a);
      if (isNaN(n)) return String(a);
      return n.toLocaleString("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 8,
      });
    }

    async function loadTransferHistory() {
      const data = await apiGet("/wallet");
      const trs  = data.transfers || [];

      elTransBody.innerHTML = "";

      if (!trs.length) {
        elTransBody.innerHTML =
          '<tr><td colspan="5" style="text-align:center; font-size:12px; color:var(--text-muted);">入出金履歴はありません。</td></tr>';
        return;
      }

      trs
        .slice()
        .sort((a, b) => {
          const ta = a.createdAt ? new Date(a.createdAt).getTime() : 0;
          const tb = b.createdAt ? new Date(b.createdAt).getTime() : 0;
          return tb - ta;
        })
        .forEach((t) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${t.id}</td>
            <td>${t.type}</td>
            <td>${fmtAmount(t.amount)}</td>
            <td>${t.status}</td>
            <td>${fmtDate(t.createdAt)}</td>
          `;
          elTransBody.appendChild(tr);
        });
    }

    async function loadTradeHistory() {
      const trades = await apiGet("/trades/history");

      elTradeBody.innerHTML = "";

      if (!trades.length) {
        elTradeBody.innerHTML =
          '<tr><td colspan="8" style="text-align:center; font-size:12px; color:var(--text-muted);">取引履歴はありません。</td></tr>';
        return;
      }

      trades.forEach((t) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t.id}</td>
          <td>${t.symbol}</td>
          <td>${t.side}</td>
          <td>${fmtAmount(t.size)}</td>
          <td>${fmtAmount(t.entryPrice)}</td>
          <td>${fmtAmount(t.closePrice)}</td>
          <td>${fmtAmount(t.profit)}</td>
          <td>${fmtDate(t.closedAt)}</td>
        `;
        elTradeBody.appendChild(tr);
      });
    }

    function setActiveTab(tab) {
      if (tab === "transfer") {
        elTabTrans.classList.add("active");
        elTabTrade.classList.remove("active");
        elSecTrans.style.display = "";
        elSecTrade.style.display = "none";
      } else {
        elTabTrade.classList.add("active");
        elTabTrans.classList.remove("active");
        elSecTrade.style.display = "";
        elSecTrans.style.display = "none";
      }
    }

    elTabTrans.addEventListener("click", (e) => {
      e.preventDefault();
      setActiveTab("transfer");
    });

    elTabTrade.addEventListener("click", async (e) => {
      e.preventDefault();
      setActiveTab("trade");
      try {
        await loadTradeHistory();
        if (elMsg) {
          elMsg.textContent = "取引履歴を更新しました。";
          elMsg.style.color = "green";
        }
      } catch (err) {
        console.error(err);
        if (elMsg) {
          elMsg.textContent = "取引履歴の取得に失敗しました。";
          elMsg.style.color = "red";
        }
      }
    });

    (async function initHistoryPage() {
      try {
        await loadTransferHistory();
        if (elMsg) {
          elMsg.textContent = "履歴を更新しました。";
          elMsg.style.color = "green";
        }
      } catch (err) {
        console.error(err);
        if (elMsg) {
          elMsg.textContent = "履歴の取得に失敗しました。ログイン状態を確認してください。";
          elMsg.style.color = "red";
        }
      }
    })();
  </script>
</body>
</html>


